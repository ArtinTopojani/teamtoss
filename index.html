<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Team Toss - Advanced Generator & Practice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <link rel="icon" type="image/x-icon" href="./images/logo.png" />
    <style>
      /* =========================================
         1. CORE WEBSITE STYLES
         ========================================= */
      body {
        font-family: 'Inter', sans-serif;
        background-color: #f0f4f8;
        color: #1e293b;
        overflow-x: hidden;
      }
      .card {
        background-color: white;
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        padding: 1.5rem;
      }
      .btn-primary {
        background-color: #3b82f6;
        color: white;
        font-weight: 600;
        padding: 0.7rem 1.4rem;
        border-radius: 0.5rem;
        transition: background-color 0.3s ease, color 0.3s ease;
        border: none;
        cursor: pointer;
      }
      .btn-primary:hover {
        background-color: #2563eb;
      }
      .btn-secondary {
        background-color: #e2e8f0;
        color: #475569;
        font-weight: 500;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        transition: background-color 0.3s ease;
        border: 1px solid #cbd5e1;
        cursor: pointer;
      }
      .btn-secondary:hover {
        background-color: #cbd5e1;
      }
      .btn-copy {
        background-color: #10b981;
        color: white;
        font-weight: 500;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        transition: background-color 0.3s ease;
        border: none;
        cursor: pointer;
      }
      .btn-copy:hover {
        background-color: #059669;
      }
      .btn-copy.copied {
        background-color: #047857;
      }

      .input-field,
      .textarea-field {
        border: 1px solid #cbd5e1;
        border-radius: 0.5rem;
        padding: 0.6rem 0.8rem;
        width: 100%;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
        font-size: 0.9rem;
        background-color: #f8fafc;
      }
      .input-field:focus,
      .textarea-field:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        background-color: white;
      }
      .textarea-field {
        min-height: 80px;
      }
      .label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: #4a5568;
        margin-bottom: 0.25rem;
      }
      .ad-placeholder {
        background-color: #ffffff;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        min-height: 90px;
        text-align: center;
        padding: 1rem;
        border: 1px solid #e2e8f0;
      }
      .ad-placeholder img {
        max-height: 70px;
        width: auto;
      }

      .team-container {
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
        min-height: 150px;
        position: relative;
        overflow: hidden;
        transition: background-color 0.3s ease;
      }
      .team-bg-light {
        background-color: #eff6ff;
        border-color: #dbeafe;
      }
      .team-bg-dark {
        background-color: #dbeafe;
        border-color: #bfdbfe;
      }
      .team-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
        border-bottom: 1px solid rgba(100, 116, 139, 0.2);
        padding-bottom: 0.5rem;
      }
      .team-bg-light .team-name-input {
        color: #1e40af;
      }
      .team-bg-dark .team-name-input {
        color: #1e3a8a;
      }
      .team-name-input {
        font-weight: 600;
        border: none;
        background: transparent;
        padding: 0.2rem 0.4rem;
        border-radius: 0.25rem;
        width: auto;
      }
      .team-name-input:focus {
        outline: none;
        background-color: rgba(255, 255, 255, 0.5);
        box-shadow: 0 0 0 1px #3b82f6;
      }

      .team-members-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        position: relative;
        margin-bottom: 1rem;
      }
      .player-tag {
        border-radius: 1rem;
        font-size: 0.85rem;
        font-weight: 500;
        padding: 0.3rem 0.8rem;
        position: absolute;
        white-space: nowrap;
        opacity: 0;
        transition: all 0.5s ease-in-out;
        transform: translateY(20px);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      }
      .team-bg-light .player-tag {
        background-color: #dbeafe;
        color: #1e40af;
      }
      .team-bg-dark .player-tag {
        background-color: #bfdbfe;
        color: #1e3a8a;
      }
      .player-tag.visible {
        opacity: 1;
        transform: translateY(0);
        position: relative;
      }

      .player-list-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background-color: #f1f5f9;
        padding: 0.5rem 0.75rem;
        border-radius: 0.375rem;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
      }
      .remove-player-btn {
        background: none;
        border: none;
        color: #ef4444;
        cursor: pointer;
        font-size: 0.8rem;
        padding: 0.2rem;
      }
      .remove-player-btn:hover {
        color: #dc2626;
      }

      .hidden-section {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.5s ease-out;
      }
      .hidden-section.show {
        max-height: 500px;
      }
      #playerList {
        overflow-y: auto;
        max-height: 70vh;
        border-radius: 0.375rem;
        border: 1px solid #e2e8f0;
        padding: 0.5rem;
        background-color: #f8fafc;
      }

      .champions-section {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid rgba(100, 116, 139, 0.2);
      }
      .champions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
        gap: 0.75rem;
        margin-bottom: 0.75rem;
      }
      .champion-item {
        text-align: center;
      }
      .champion-item img {
        width: 50px;
        height: 50px;
        border-radius: 0.375rem;
        margin: 0 auto 0.25rem;
        display: block;
        border: 1px solid rgba(0, 0, 0, 0.1);
        background-color: #e2e8f0;
      }
      .champion-item span {
        font-size: 0.75rem;
        color: #475569;
        display: block;
        word-wrap: break-word;
      }

      .form-checkbox {
        appearance: none;
        padding: 0;
        display: inline-block;
        vertical-align: middle;
        height: 1rem;
        width: 1rem;
        color: #3b82f6;
        background-color: #fff;
        border-color: #6b7280;
        border-width: 1px;
        border-radius: 0.25rem;
      }
      .form-checkbox:checked {
        border-color: transparent;
        background-color: currentColor;
        background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
      }

      #combinedChampionsSection {
        display: none;
        margin-top: 1rem;
      }

      /* =========================================
         2. GAME & BUTTON STYLES
         ========================================= */

      /* Fancy Game Entry Button */
      .game-card-btn {
        background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
        color: white;
        border-radius: 0.75rem;
        padding: 1.5rem;
        position: relative;
        overflow: hidden;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3);
        margin-bottom: 1.5rem;
      }
      .game-card-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.4);
      }
      .game-new-badge {
        position: absolute;
        top: 0;
        right: 0;
        background-color: #facc15;
        color: #1e3a8a;
        font-size: 0.7rem;
        font-weight: 800;
        padding: 0.25rem 0.75rem;
        border-bottom-left-radius: 0.5rem;
        z-index: 10;
      }

      /* Game Overlay (Fullscreen) */
      #game-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: #0f172a;
        z-index: 9999;
        display: none;
        overflow: hidden;
        cursor: crosshair;
      }

      canvas {
        display: block;
        position: absolute;
        top: 0;
        left: 0;
      }

      #player-sprite {
        position: absolute;
        width: 200px; /* Large size for visibility */
        height: 200px;
        transform: translate(-50%, -50%);
        z-index: 10;
        pointer-events: none;
        filter: drop-shadow(0 15px 15px rgba(0, 0, 0, 0.6));
      }

      #game-ui {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        padding: 2rem;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        z-index: 20;
      }
      .hud-top {
        display: flex;
        justify-content: space-between;
        color: white;
        font-family: monospace;
        text-shadow: 2px 2px 0 #000;
        font-size: 1.5rem;
        font-weight: bold;
      }
      .hud-bottom {
        display: flex;
        justify-content: center;
        gap: 2rem;
        pointer-events: auto;
      }
      .ability-icon {
        width: 70px;
        height: 70px;
        background: #1e293b;
        border: 3px solid #475569;
        border-radius: 10px;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 1.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
      }
      .ability-icon.ready {
        border-color: #facc15;
        box-shadow: 0 0 20px rgba(250, 204, 21, 0.6);
      }
      .cooldown-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 0%;
        background: rgba(0, 0, 0, 0.85);
        transition: height 0.1s linear;
      }
      .cooldown-text {
        position: absolute;
        font-size: 1.2rem;
        z-index: 2;
        color: #fff;
      }

      /* Menu & Game Over Screen */
      #game-menu,
      #game-over-screen {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        background: rgba(15, 23, 42, 0.95);
        padding: 3rem;
        border-radius: 1rem;
        pointer-events: auto;
        border: 1px solid #475569;
        z-index: 30;
        min-width: 400px;
      }

      #game-over-screen {
        display: none; /* Hidden by default */
        flex-direction: column;
        gap: 1.5rem;
      }

      .key-badge {
        background: #334155;
        padding: 0.2rem 0.6rem;
        border-radius: 4px;
        border: 1px solid #475569;
        color: #facc15;
        font-weight: bold;
        margin-right: 8px;
      }

      /* Exit button specifically for Game Over top left */
      #btn-exit-top-left {
        position: absolute;
        top: 20px;
        left: 20px;
        background-color: #ef4444;
        color: white;
        padding: 0.8rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: bold;
        border: 2px solid #b91c1c;
        cursor: pointer;
        pointer-events: auto;
        z-index: 50;
        display: none; /* Hidden by default */
      }
      #btn-exit-top-left:hover {
        background-color: #dc2626;
      }
    </style>
  </head>
  <body class="p-4 md:p-8">
    <header class="text-center mb-8">
      <h1 class="text-4xl md:text-5xl font-bold text-[#3B82F6]">Team Toss</h1>
      <p class="text-lg text-gray-600 mt-2">
        Generate teams with advanced customization
      </p>
    </header>

    <div class="container mx-auto max-w-7xl">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- LEFT COLUMN -->
        <div class="lg:col-span-1 space-y-6">
          <!-- 1. Participants Card -->
          <div class="card">
            <h2 class="text-xl font-semibold mb-4">1. Add Participants</h2>
            <div class="mb-4">
              <label for="playerName" class="label">Add Single Player:</label>
              <div class="flex gap-2">
                <input
                  type="text"
                  id="playerName"
                  class="input-field flex-grow"
                  placeholder="Enter name"
                />
                <button id="addPlayerBtn" class="btn-secondary flex-shrink-0">
                  Add
                </button>
              </div>
            </div>
            <div class="mb-4">
              <label for="bulkPlayerNames" class="label"
                >Add Multiple Players (comma-separated):</label
              >
              <textarea
                id="bulkPlayerNames"
                class="textarea-field"
                placeholder="e.g., Alice, Bob, Charlie, Tata"
              ></textarea>
              <button id="addBulkPlayersBtn" class="btn-secondary w-full mt-2">
                Add Players from List
              </button>
            </div>
            <h3 class="text-lg font-semibold mt-6 mb-2">
              Current Participants:
            </h3>
            <div id="playerList">
              <p class="text-gray-500 text-sm italic text-center p-2">
                No players added yet.
              </p>
            </div>
            <p id="player-count" class="text-sm text-gray-600 mt-2">Total: 0</p>
          </div>

          <!-- ============================================ -->
          <!-- GAME ENTRY BUTTON -->
          <!-- ============================================ -->
          <div id="openGameBtn" class="game-card-btn group">
            <div class="game-new-badge">NEW</div>
            <div class="relative z-10 flex items-center justify-between">
              <div>
                <h3 class="font-bold text-xl mb-1 flex items-center">
                  <i class="fas fa-gamepad mr-2 text-blue-200"></i> Practice
                  Kiting
                </h3>
                <p class="text-blue-100 text-sm opacity-90">
                  Warm up your mechanics!
                </p>
              </div>
              <i
                class="fas fa-chevron-right text-white opacity-70 group-hover:translate-x-1 transition-transform"
              ></i>
            </div>
            <!-- Decorative circle overlay -->
            <div
              class="absolute -bottom-6 -right-6 w-24 h-24 bg-white opacity-10 rounded-full"
            ></div>
          </div>
          <!-- ============================================ -->

          <!-- 2. Terms & Conditions Card -->
          <div class="card">
            <div class="flex justify-between items-center mb-3">
              <h2 class="text-xl font-semibold">Terms & Conditions</h2>
              <button
                id="toggleRiggingBtn"
                class="text-sm text-blue-600 hover:text-blue-800"
              >
                Show <i class="fas fa-chevron-down text-xs ml-1"></i>
              </button>
            </div>
            <div id="riggingSection" class="hidden-section space-y-3">
              <p class="text-sm text-gray-600">
                Enter two names to ensure they are on the same team.
              </p>
              <div>
                <label for="riggedName1" class="label">Name 1:</label>
                <input
                  type="text"
                  id="riggedName1"
                  class="input-field"
                  placeholder="First rigged name"
                />
              </div>
              <div>
                <label for="riggedName2" class="label">Name 2:</label>
                <input
                  type="text"
                  id="riggedName2"
                  class="input-field"
                  placeholder="Second rigged name"
                />
              </div>
            </div>
          </div>
        </div>

        <!-- RIGHT COLUMN (Teams & Config) -->
        <div class="lg:col-span-2 space-y-6">
          <div class="card">
            <h2 class="text-xl font-semibold mb-4">Generated Teams</h2>
            <p id="generation-status" class="text-gray-500 mb-4">
              Add participants and configure settings to generate teams.
            </p>
            <div
              id="teamsOutput"
              class="grid grid-cols-1 md:grid-cols-2 gap-4"
            ></div>
            <div id="combinedChampionsSection">
              <label for="combinedChampionList" class="label mt-4 mb-2"
                >Combined Champion List:</label
              >
              <textarea
                id="combinedChampionList"
                readonly
                class="textarea-field"
              ></textarea>
              <button id="copyChampionsBtn" class="btn-copy w-full mt-2">
                <i class="fas fa-clipboard mr-2"></i>Copy All Champions
              </button>
            </div>
          </div>

          <div class="card">
            <h2 class="text-xl font-semibold mb-4">2. Configure Teams</h2>
            <div class="space-y-4">
              <div>
                <label class="label">Grouping Method:</label>
                <div class="flex space-x-4">
                  <label class="flex items-center">
                    <input
                      type="radio"
                      name="groupingMethod"
                      value="numTeams"
                      checked
                      class="form-radio text-blue-600 focus:ring-blue-500"
                    />
                    <span class="ml-2 text-sm">Number of Teams</span>
                  </label>
                  <label class="flex items-center">
                    <input
                      type="radio"
                      name="groupingMethod"
                      value="maxPerTeam"
                      class="form-radio text-blue-600 focus:ring-blue-500"
                    />
                    <span class="ml-2 text-sm">Max Per Team</span>
                  </label>
                </div>
              </div>
              <div id="numTeamsInputContainer">
                <label for="numTeams" class="label">Number of Teams:</label>
                <input
                  type="number"
                  id="numTeams"
                  class="input-field w-full"
                  value="2"
                  min="2"
                />
              </div>
              <div id="maxPerTeamInputContainer" style="display: none">
                <label for="maxPerTeam" class="label"
                  >Max Players Per Team:</label
                >
                <input
                  type="number"
                  id="maxPerTeam"
                  class="input-field w-full"
                  value="5"
                  min="1"
                />
              </div>
              <div>
                <label class="flex items-center mt-2">
                  <input
                    type="checkbox"
                    id="generateLolChampions"
                    class="form-checkbox mr-2 text-blue-600 focus:ring-blue-500"
                  />
                  <span class="text-sm"
                    >Generate LoL Champions (ARAM Style)</span
                  >
                </label>
                <p
                  id="lol-status"
                  class="text-xs text-gray-500 mt-1 ml-6 h-3"
                ></p>
              </div>
            </div>
            <button id="generateButton" class="btn-primary w-full mt-6">
              Generate Teams
            </button>
            <p id="error-message" class="text-red-500 text-sm mt-2 h-4"></p>
          </div>
        </div>
      </div>

      <div class="mt-8">
        <p class="text-gray-400 text-sm mb-4">Weâ€™re here thanks to:</p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <a
            href="https://www.instagram.com/jeshil_store/"
            target="_blank"
            class="ad-placeholder hover:shadow-md transition-shadow duration-200"
          >
            <img
              src="./images/jeshil_logo.png"
              alt="Ad Jeshil Store"
              onerror="this.onerror=null; this.src='https://placehold.co/150x50/e2e8f0/64748b?text=Ad+Jeshil+Store';"
            />
          </a>
          <a
            href="#"
            target="_blank"
            class="ad-placeholder hover:shadow-md transition-shadow duration-200"
          >
            <img
              src="./images/gezimi_logo.png"
              alt="Ad Market Gezimi"
              onerror="this.onerror=null; this.src='https://placehold.co/150x50/e2e8f0/64748b?text=Ad+Market+Gezimi';"
            />
          </a>
        </div>
      </div>
    </div>

    <!-- ========================================== -->
    <!-- GAME OVERLAY (Initially Hidden)            -->
    <!-- ========================================== -->
    <div id="game-overlay">
      <!-- Exit Button (Shows on Game Over) -->
      <button id="btn-exit-top-left">
        <i class="fas fa-arrow-left mr-2"></i> EXIT TO MAIN
      </button>

      <!-- 1. The Canvas -->
      <canvas id="gameCanvas"></canvas>

      <!-- 2. The Player Sprite (DOM Element) -->
      <img id="player-sprite" src="./images/ezreal_top.gif" alt="Player" />

      <!-- 3. UI HUD -->
      <div id="game-ui">
        <div class="hud-top">
          <div>
            <div class="text-yellow-400">EZREAL KITING</div>
            <div class="text-sm text-gray-300">
              Wave: <span id="hud-wave">1</span>
            </div>
          </div>
          <div class="text-right">
            <div>
              Score: <span id="hud-score" class="text-green-400">0</span>
            </div>
            <div class="text-sm">
              HP: <span id="hud-hp" class="text-red-400">3</span>
            </div>
          </div>
        </div>

        <!-- START MENU -->
        <div id="game-menu">
          <h2 class="text-3xl font-bold mb-6 text-yellow-400">CONTROLS</h2>
          <ul class="text-left space-y-3 mb-8 text-lg text-gray-200">
            <li><span class="key-badge">RMB</span> Move (Kiting)</li>
            <li><span class="key-badge">Mouse</span> Aim</li>
            <li><span class="key-badge">Q</span> Mystic Shot</li>
            <li><span class="key-badge">E</span> Arcane Shift</li>
            <li><span class="key-badge">F</span> Flash</li>
            <li><span class="key-badge">ESC</span> Exit</li>
          </ul>
          <button
            id="btn-start-game"
            class="btn-primary text-xl px-10 py-3 w-full"
          >
            START
          </button>
        </div>

        <!-- GAME OVER SCREEN -->
        <div id="game-over-screen">
          <h1 class="text-5xl font-bold text-red-500 mb-2">GAME OVER</h1>
          <div class="text-2xl text-white mb-4">
            Score:
            <span id="final-score" class="text-yellow-400 font-bold">0</span>
          </div>
          <div class="text-lg text-gray-400 mb-8">
            Session High Score:
            <span id="high-score" class="text-white">0</span>
          </div>
          <button
            id="btn-restart"
            class="btn-primary text-xl px-10 py-3 w-full"
          >
            <i class="fas fa-redo mr-2"></i> RESTART
          </button>
        </div>

        <div class="hud-bottom">
          <div class="ability-icon" id="icon-q">
            Q
            <div class="cooldown-overlay" id="cd-q"></div>
            <span class="cooldown-text" id="cdt-q"></span>
          </div>
          <div class="ability-icon" id="icon-e">
            E
            <div class="cooldown-overlay" id="cd-e"></div>
            <span class="cooldown-text" id="cdt-e"></span>
          </div>
          <div class="ability-icon" id="icon-f">
            F
            <div class="cooldown-overlay" id="cd-f"></div>
            <span class="cooldown-text" id="cdt-f"></span>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ===================================
      // 1. TEAM TOSS LOGIC
      // ===================================
      let players = [];
      let riggedPair = [];
      let nextPlayerId = 0;
      let lolChampions = [];
      let lolVersion = '';
      let lolDataStatus = 'idle';

      const playerNameInput = document.getElementById('playerName');
      const addPlayerBtn = document.getElementById('addPlayerBtn');
      const bulkPlayerNamesInput = document.getElementById('bulkPlayerNames');
      const addBulkPlayersBtn = document.getElementById('addBulkPlayersBtn');
      const playerListDiv = document.getElementById('playerList');
      const playerCountP = document.getElementById('player-count');
      const toggleRiggingBtn = document.getElementById('toggleRiggingBtn');
      const riggingSection = document.getElementById('riggingSection');
      const riggedName1Input = document.getElementById('riggedName1');
      const riggedName2Input = document.getElementById('riggedName2');
      const groupingMethodRadios = document.querySelectorAll(
        'input[name="groupingMethod"]'
      );
      const numTeamsInputContainer = document.getElementById(
        'numTeamsInputContainer'
      );
      const numTeamsInput = document.getElementById('numTeams');
      const maxPerTeamInputContainer = document.getElementById(
        'maxPerTeamInputContainer'
      );
      const maxPerTeamInput = document.getElementById('maxPerTeam');
      const generateButton = document.getElementById('generateButton');
      const teamsOutput = document.getElementById('teamsOutput');
      const errorMessage = document.getElementById('error-message');
      const generationStatus = document.getElementById('generation-status');
      const generateLolChampionsCheckbox = document.getElementById(
        'generateLolChampions'
      );
      const lolStatus = document.getElementById('lol-status');
      const combinedChampionsSection = document.getElementById(
        'combinedChampionsSection'
      );
      const combinedChampionListTextarea = document.getElementById(
        'combinedChampionList'
      );
      const copyChampionsBtn = document.getElementById('copyChampionsBtn');

      async function fetchLolData() {
        if (lolDataStatus === 'loaded' || lolDataStatus === 'loading') return;
        lolDataStatus = 'loading';
        lolStatus.textContent = 'Loading LoL data...';
        generateLolChampionsCheckbox.disabled = true;
        try {
          const versionResponse = await fetch(
            'https://ddragon.leagueoflegends.com/api/versions.json'
          );
          if (!versionResponse.ok)
            throw new Error('Failed to fetch LoL versions');
          const versions = await versionResponse.json();
          lolVersion = versions[0];
          const championResponse = await fetch(
            `https://ddragon.leagueoflegends.com/cdn/${lolVersion}/data/en_US/champion.json`
          );
          if (!championResponse.ok)
            throw new Error('Failed to fetch LoL champions');
          const championData = await championResponse.json();
          lolChampions = Object.values(championData.data).map((champ) => ({
            id: champ.id,
            name: champ.name,
            key: champ.key,
          }));
          lolDataStatus = 'loaded';
          lolStatus.textContent = `LoL data loaded (v${lolVersion})`;
          generateLolChampionsCheckbox.disabled = false;
        } catch (error) {
          lolDataStatus = 'error';
          lolStatus.textContent = 'Error loading LoL data.';
          generateLolChampionsCheckbox.disabled = true;
          showError(
            'Could not load League of Legends champion data. Feature disabled.'
          );
        }
      }

      function renderPlayerList() {
        playerListDiv.innerHTML = '';
        if (players.length === 0) {
          playerListDiv.innerHTML =
            '<p class="text-gray-500 text-sm italic text-center p-2">No players added yet.</p>';
        } else {
          players.forEach((player) => {
            const playerItem = document.createElement('div');
            playerItem.className = 'player-list-item';
            playerItem.innerHTML = `<span class="truncate" title="${player.name}">${player.name}</span><button class="remove-player-btn flex-shrink-0" data-id="${player.id}">&times; Remove</button>`;
            playerListDiv.appendChild(playerItem);
          });
        }
        playerCountP.textContent = `Total: ${players.length}`;
      }

      function addSinglePlayer() {
        const name = playerNameInput.value.trim();
        if (!name) {
          showError('Player name cannot be empty.');
          return;
        }
        if (players.some((p) => p.name.toLowerCase() === name.toLowerCase())) {
          showError(`Player "${name}" already exists.`);
          return;
        }
        players.push({ id: nextPlayerId++, name });
        renderPlayerList();
        playerNameInput.value = '';
        playerNameInput.focus();
        clearError();
      }

      function addBulkPlayers() {
        const namesString = bulkPlayerNamesInput.value.trim();
        if (!namesString) {
          showError('Bulk player list cannot be empty.');
          return;
        }
        const namesToAdd = namesString
          .split(',')
          .map((name) => name.trim())
          .filter((name) => name !== '');
        if (namesToAdd.length === 0) {
          showError('No valid names found in the list.');
          return;
        }
        let addedCount = 0;
        let duplicateCount = 0;
        namesToAdd.forEach((name) => {
          if (
            !players.some((p) => p.name.toLowerCase() === name.toLowerCase())
          ) {
            players.push({ id: nextPlayerId++, name });
            addedCount++;
          } else {
            duplicateCount++;
          }
        });
        if (addedCount > 0) {
          renderPlayerList();
          bulkPlayerNamesInput.value = '';
          clearError();
          if (duplicateCount > 0) {
            errorMessage.textContent = `Added ${addedCount} players. Skipped ${duplicateCount} duplicate(s).`;
            setTimeout(() => {
              if (
                errorMessage.textContent ===
                `Added ${addedCount} players. Skipped ${duplicateCount} duplicate(s).`
              )
                clearError();
            }, 5000);
          }
        } else if (duplicateCount > 0) {
          showError(`All ${duplicateCount} names in the list already exist.`);
        }
      }

      function removePlayer(id) {
        players = players.filter((player) => player.id !== id);
        renderPlayerList();
      }

      function toggleRigging() {
        const isHidden = riggingSection.classList.contains('hidden-section');
        if (isHidden) {
          riggingSection.classList.remove('hidden-section');
          riggingSection.classList.add('show');
          toggleRiggingBtn.innerHTML =
            'Hide <i class="fas fa-chevron-up text-xs ml-1"></i>';
        } else {
          riggingSection.classList.remove('show');
          riggingSection.classList.add('hidden-section');
          toggleRiggingBtn.innerHTML =
            'Show <i class="fas fa-chevron-down text-xs ml-1"></i>';
        }
      }

      function updateGroupingInputs() {
        const selectedMethod = document.querySelector(
          'input[name="groupingMethod"]:checked'
        ).value;
        numTeamsInputContainer.style.display =
          selectedMethod === 'numTeams' ? 'block' : 'none';
        maxPerTeamInputContainer.style.display =
          selectedMethod === 'maxPerTeam' ? 'block' : 'none';
      }

      function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      }

      function showError(message) {
        errorMessage.textContent = message;
        setTimeout(clearError, 5000);
      }
      function clearError() {
        if (
          errorMessage.textContent &&
          !errorMessage.textContent.startsWith('Added')
        ) {
          errorMessage.textContent = '';
        }
      }

      async function generateTeams() {
        clearError();
        generationStatus.textContent = 'Generating teams...';
        teamsOutput.innerHTML = '';
        combinedChampionsSection.style.display = 'none';

        const generateLol = generateLolChampionsCheckbox.checked;

        if (generateLol && lolDataStatus !== 'loaded') {
          showError(
            'LoL Champion data is not loaded or failed to load. Cannot generate champions.'
          );
          generationStatus.textContent = 'Generation failed.';
          return;
        }

        const groupingMethod = document.querySelector(
          'input[name="groupingMethod"]:checked'
        ).value;
        let numTeams = 0;
        const maxPerTeamVal = parseInt(maxPerTeamInput.value);

        if (groupingMethod === 'numTeams') {
          numTeams = parseInt(numTeamsInput.value);
        } else {
          if (isNaN(maxPerTeamVal) || maxPerTeamVal < 1) {
            showError(
              'Please enter a valid maximum number of players per team.'
            );
            generationStatus.textContent = 'Generation failed.';
            return;
          }
          numTeams =
            players.length > 0
              ? Math.max(1, Math.ceil(players.length / maxPerTeamVal))
              : 0;
        }

        if (players.length === 0) {
          showError('Please add participants before generating teams.');
          generationStatus.textContent =
            'Add participants and configure settings to generate teams.';
          return;
        }
        if (players.length > 1 && numTeams < 2) {
          if (groupingMethod === 'maxPerTeam') {
            numTeams = 2;
          } else {
            showError(
              'Number of teams must be at least 2 (unless only 1 participant exists).'
            );
            generationStatus.textContent = 'Generation failed.';
            return;
          }
        }
        if (players.length === 1) {
          numTeams = 1;
        }
        if (players.length < numTeams) {
          showError(
            'Not enough participants for the specified number of teams.'
          );
          generationStatus.textContent = 'Generation failed.';
          return;
        }

        riggedPair = [];
        const name1 = riggedName1Input.value.trim().toLowerCase();
        const name2 = riggedName2Input.value.trim().toLowerCase();
        let actualRiggedPlayers = [];
        let playersToShuffle = [...players];

        if (name1 && name2 && name1 !== name2) {
          const player1 = players.find((p) => p.name.toLowerCase() === name1);
          const player2 = players.find((p) => p.name.toLowerCase() === name2);
          if (player1 && player2) {
            riggedPair = [player1.name, player2.name];
            actualRiggedPlayers = [player1, player2];
            playersToShuffle = playersToShuffle.filter(
              (p) => p.id !== player1.id && p.id !== player2.id
            );
          } else {
            let missingMsg = 'Rigged player(s) not found: ';
            if (!player1) missingMsg += `"${riggedName1Input.value.trim()}"`;
            if (!player1 && !player2) missingMsg += ', ';
            if (!player2) missingMsg += `"${riggedName2Input.value.trim()}"`;
            showError(missingMsg + '.');
            generationStatus.textContent = 'Generation failed.';
            return;
          }
        } else if (name1 || name2) {
          showError('Please enter both names for rigging or leave both empty.');
          generationStatus.textContent = 'Generation failed.';
          return;
        }
        if (actualRiggedPlayers.length > 0 && numTeams < 1) {
          showError('Cannot rig players with less than 1 team.');
          generationStatus.textContent = 'Generation failed.';
          return;
        }

        shuffleArray(playersToShuffle);
        const teams = Array.from({ length: numTeams }, () => ({
          name: '',
          members: [],
          champions: [],
        }));
        teams.forEach((team, index) => (team.name = `Team ${index + 1}`));

        if (actualRiggedPlayers.length > 0) {
          const riggedTeamIndex = Math.floor(Math.random() * numTeams);
          teams[riggedTeamIndex].members.push(...actualRiggedPlayers);
        }

        playersToShuffle.forEach((player) => {
          teams.sort((a, b) => a.members.length - b.members.length);
          teams[0].members.push(player);
        });

        let combinedChampionText = '';
        if (generateLol) {
          const shuffledChampions = shuffleArray([...lolChampions]);
          let champPoolIndex = 0;
          teams.forEach((team, teamIdx) => {
            const teamSize = team.members.length;
            if (teamSize > 0) {
              const numChampionsToPick = teamSize * 2 + 1;
              let teamChampions = [];
              for (let i = 0; i < numChampionsToPick; i++) {
                if (champPoolIndex >= shuffledChampions.length) {
                  console.warn('Ran out of unique champions.');
                  break;
                }
                const pickedChamp = shuffledChampions[champPoolIndex];
                team.champions.push(pickedChamp);
                teamChampions.push(pickedChamp.name);
                champPoolIndex++;
              }
              combinedChampionText += `${team.name}: ${teamChampions.join(
                ', '
              )}\n`;
            }
          });
          if (combinedChampionText) {
            combinedChampionListTextarea.value = combinedChampionText.trim();
            combinedChampionsSection.style.display = 'block';
          }
        }

        displayTeamsWithAnimation(teams, generateLol);
        generationStatus.textContent = 'Teams generated successfully!';
      }

      async function displayTeamsWithAnimation(teamsData, includeChampions) {
        teamsOutput.innerHTML = '';

        teamsData.forEach((team, index) => {
          const teamContainer = document.createElement('div');
          const bgClass = index % 2 === 0 ? 'team-bg-light' : 'team-bg-dark';
          teamContainer.className = `team-container ${bgClass}`;

          let championsHTML = '';
          if (includeChampions && team.champions.length > 0) {
            const championItems = team.champions
              .map(
                (champ) => `
                        <div class="champion-item">
                            <img src="https://ddragon.leagueoflegends.com/cdn/${lolVersion}/img/champion/${champ.id}.png" alt="${champ.name}" loading="lazy" onerror="this.style.visibility='hidden'">
                            <span>${champ.name}</span>
                        </div>`
              )
              .join('');

            championsHTML = `
                        <div class="champions-section">
                            <h4 class="text-sm font-semibold mb-2 ${
                              bgClass === 'team-bg-light'
                                ? 'text-blue-800'
                                : 'text-blue-900'
                            }">Champions (${team.champions.length}):</h4>
                            <div class="champions-grid">${championItems}</div>
                        </div>`;
          }

          teamContainer.innerHTML = `
                    <div class="team-header">
                        <input type="text" class="team-name-input" value="${team.name}" data-team-index="${index}" placeholder="Enter Team Name">
                        <span class="text-sm font-medium">Members: <span class="member-count">0</span></span>
                    </div>
                    <div class="team-members-list" id="team-list-${index}"></div>
                    ${championsHTML}`;
          teamsOutput.appendChild(teamContainer);

          const nameInput = teamContainer.querySelector('.team-name-input');
          nameInput.addEventListener('change', (e) => {
            console.log(`Team ${index + 1} renamed to: ${e.target.value}`);
          });
        });

        const allAssignedPlayers = teamsData.flatMap((team) => team.members);
        shuffleArray(allAssignedPlayers);

        for (let i = 0; i < allAssignedPlayers.length; i++) {
          const player = allAssignedPlayers[i];
          const teamIndex = teamsData.findIndex((team) =>
            team.members.some((member) => member.id === player.id)
          );
          if (teamIndex !== -1) {
            const teamListElement = document.getElementById(
              `team-list-${teamIndex}`
            );
            const teamContainer = teamListElement.closest('.team-container');
            const memberCountSpan =
              teamContainer.querySelector('.member-count');
            const playerTag = document.createElement('div');
            playerTag.className = 'player-tag';
            playerTag.textContent = player.name;
            teamListElement.appendChild(playerTag);
            await new Promise((resolve) => setTimeout(resolve, 10));
            playerTag.classList.add('visible');
            memberCountSpan.textContent =
              parseInt(memberCountSpan.textContent) + 1;
            await new Promise((resolve) => setTimeout(resolve, 150));
          }
        }
      }

      function copyCombinedChampions() {
        const textToCopy = combinedChampionListTextarea.value;
        if (navigator.clipboard && textToCopy) {
          navigator.clipboard
            .writeText(textToCopy)
            .then(() => {
              const originalText = copyChampionsBtn.innerHTML;
              copyChampionsBtn.innerHTML =
                '<i class="fas fa-check mr-2"></i>Copied!';
              copyChampionsBtn.classList.add('copied');
              setTimeout(() => {
                copyChampionsBtn.innerHTML = originalText;
                copyChampionsBtn.classList.remove('copied');
              }, 2000);
            })
            .catch((err) => {
              console.error('Failed to copy text: ', err);
              showError('Failed to copy champions to clipboard.');
            });
        } else if (textToCopy) {
          try {
            combinedChampionListTextarea.select();
            document.execCommand('copy');
            const originalText = copyChampionsBtn.innerHTML;
            copyChampionsBtn.innerHTML =
              '<i class="fas fa-check mr-2"></i>Copied!';
            copyChampionsBtn.classList.add('copied');
            setTimeout(() => {
              copyChampionsBtn.innerHTML = originalText;
              copyChampionsBtn.classList.remove('copied');
            }, 2000);
          } catch (err) {
            console.error('Fallback copy failed: ', err);
            showError('Failed to copy champions to clipboard.');
          }
        }
      }

      addPlayerBtn.addEventListener('click', addSinglePlayer);
      playerNameInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') addSinglePlayer();
      });
      addBulkPlayersBtn.addEventListener('click', addBulkPlayers);
      playerListDiv.addEventListener('click', (e) => {
        if (e.target.classList.contains('remove-player-btn'))
          removePlayer(parseInt(e.target.getAttribute('data-id')));
      });
      toggleRiggingBtn.addEventListener('click', toggleRigging);
      groupingMethodRadios.forEach((radio) => {
        radio.addEventListener('change', updateGroupingInputs);
      });
      generateButton.addEventListener('click', generateTeams);
      generateLolChampionsCheckbox.addEventListener('change', () => {
        if (generateLolChampionsCheckbox.checked && lolDataStatus === 'idle') {
          fetchLolData();
        }
      });
      copyChampionsBtn.addEventListener('click', copyCombinedChampions);

      renderPlayerList();
      updateGroupingInputs();

      // ============================================
      // 2. KITING PRACTICE GAME LOGIC (Canvas)
      // ============================================
      const CONF = {
        speed: 400,
        qSpeed: 1200,
        qRange: 1000,
        qCd: 0.5,
        eCd: 6,
        eDist: 300,
        fCd: 15,
        fDist: 450,
        minionSpeed: 130,
        spawnRate: 4,
        playerHitbox: 50,
        minionHitbox: 50,
      };

      const canvas = document.getElementById('gameCanvas');
      const ctx = canvas.getContext('2d');
      const playerEl = document.getElementById('player-sprite');
      const overlay = document.getElementById('game-overlay');
      const menu = document.getElementById('game-menu');
      const gameOverScreen = document.getElementById('game-over-screen');
      const exitBtnTopLeft = document.getElementById('btn-exit-top-left');

      let gameActive = false;
      let lastTime = 0;
      let sessionHighScore = 0;

      const imgMap = new Image();
      imgMap.src = './images/map_floor.jpg';

      const imgMinion = new Image();
      imgMinion.src = './images/minion_red.png';

      const imgQ = new Image();
      imgQ.src = './images/ezreal_q.png';

      let gamePlayer = { x: 0, y: 0, tx: 0, ty: 0, moving: false };
      let projectiles = [];
      let minions = [];
      let clickMarker = { x: 0, y: 0, life: 0 };

      let gameState = {
        hp: 3,
        score: 0,
        wave: 1,
        waveTimer: 0,
        cds: { q: 0, e: 0, f: 0 },
      };

      let mapRect = { x: 0, y: 0, w: 0, h: 0 };
      let mouse = { x: 0, y: 0 };

      // Open Game
      document.getElementById('openGameBtn').addEventListener('click', () => {
        overlay.style.display = 'block';
        if (document.documentElement.requestFullscreen) {
          document.documentElement.requestFullscreen().catch(console.error);
        }
        menu.style.display = 'block';
        gameOverScreen.style.display = 'none'; // Ensure GO screen is hidden
        exitBtnTopLeft.style.display = 'none';
        resizeCanvas();
        requestAnimationFrame(gameLoop);
      });

      // Start Game
      document
        .getElementById('btn-start-game')
        .addEventListener('click', () => {
          menu.style.display = 'none';
          resetGame();
          gameActive = true;
          lastTime = performance.now();
          requestAnimationFrame(gameLoop);
        });

      // Restart Game
      document.getElementById('btn-restart').addEventListener('click', () => {
        gameOverScreen.style.display = 'none';
        exitBtnTopLeft.style.display = 'none';
        resetGame();
        gameActive = true;
        lastTime = performance.now();
        // Loop is likely still running, but if not, restart it
      });

      // Exit Game Button (Top Left)
      exitBtnTopLeft.addEventListener('click', () => {
        if (document.fullscreenElement) {
          document.exitFullscreen();
        } else {
          gameActive = false;
          overlay.style.display = 'none';
        }
      });

      // Exit on Escape or Fullscreen Change
      document.addEventListener('fullscreenchange', () => {
        if (!document.fullscreenElement) {
          gameActive = false;
          overlay.style.display = 'none';
        }
      });

      window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && overlay.style.display === 'block') {
          if (document.fullscreenElement) {
            document.exitFullscreen();
          } else {
            gameActive = false;
            overlay.style.display = 'none';
          }
        }
      });

      window.addEventListener('resize', resizeCanvas);
      document.addEventListener('contextmenu', (e) => {
        if (overlay.style.display === 'block') e.preventDefault();
      });

      function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        const aspectRatio =
          imgMap.width && imgMap.height ? imgMap.width / imgMap.height : 1.77;
        mapRect.w = window.innerWidth;
        mapRect.h = mapRect.w / aspectRatio;
        mapRect.x = 0;
        mapRect.y = (window.innerHeight - mapRect.h) / 2;
      }

      function resetGame() {
        gameState.hp = 3;
        gameState.score = 0;
        gameState.wave = 1;
        gameState.waveTimer = 0;
        gameState.cds = { q: 0, e: 0, f: 0 };

        gamePlayer.x = window.innerWidth / 2;
        gamePlayer.y = window.innerHeight / 2;
        gamePlayer.moving = false;

        projectiles = [];
        minions = [];
        updateHUD();
      }

      function gameLoop(timestamp) {
        let dt = (timestamp - lastTime) / 1000;
        lastTime = timestamp;
        if (dt > 0.1) dt = 0.1;

        if (gameActive) updateGame(dt);
        renderGame();

        if (overlay.style.display !== 'none') {
          requestAnimationFrame(gameLoop);
        }
      }

      function updateGame(dt) {
        if (gameState.cds.q > 0) gameState.cds.q -= dt;
        if (gameState.cds.e > 0) gameState.cds.e -= dt;
        if (gameState.cds.f > 0) gameState.cds.f -= dt;

        gameState.waveTimer -= dt;
        if (gameState.waveTimer <= 0) {
          spawnWave();
          gameState.waveTimer = CONF.spawnRate;
        }

        if (gamePlayer.moving) {
          const dx = gamePlayer.tx - gamePlayer.x;
          const dy = gamePlayer.ty - gamePlayer.y;
          const dist = Math.sqrt(dx * dx + dy * dy);
          const moveStep = CONF.speed * dt;

          if (gamePlayer.tx < gamePlayer.x) {
            playerEl.style.transform = 'translate(-50%, -50%) scaleX(-1)';
          } else {
            playerEl.style.transform = 'translate(-50%, -50%) scaleX(1)';
          }

          if (dist <= moveStep) {
            gamePlayer.x = gamePlayer.tx;
            gamePlayer.y = gamePlayer.ty;
            gamePlayer.moving = false;
          } else {
            gamePlayer.x += (dx / dist) * moveStep;
            gamePlayer.y += (dy / dist) * moveStep;
          }
        }

        for (let i = projectiles.length - 1; i >= 0; i--) {
          let p = projectiles[i];
          p.x += p.vx * dt;
          p.y += p.vy * dt;

          if (
            p.x < -500 ||
            p.x > canvas.width + 500 ||
            p.y < -500 ||
            p.y > canvas.height + 500
          ) {
            projectiles.splice(i, 1);
            continue;
          }

          let hit = false;
          for (let mIndex = minions.length - 1; mIndex >= 0; mIndex--) {
            let m = minions[mIndex];
            let dx = p.x - m.x;
            let dy = p.y - m.y;
            if (Math.sqrt(dx * dx + dy * dy) < CONF.minionHitbox + 10) {
              minions.splice(mIndex, 1);
              gameState.score += 10;
              hit = true;
              break;
            }
          }
          if (hit) projectiles.splice(i, 1);
        }

        for (let i = minions.length - 1; i >= 0; i--) {
          let m = minions[i];
          let dx = gamePlayer.x - m.x;
          let dy = gamePlayer.y - m.y;
          let dist = Math.sqrt(dx * dx + dy * dy);

          if (dist > 0) {
            m.x += (dx / dist) * CONF.minionSpeed * dt;
            m.y += (dy / dist) * CONF.minionSpeed * dt;
          }

          if (dist < CONF.playerHitbox + CONF.minionHitbox - 30) {
            damagePlayer();
            minions.splice(i, 1);
          }
        }

        if (clickMarker.life > 0) clickMarker.life -= dt * 3;
        updateHUD();
      }

      function renderGame() {
        ctx.fillStyle = '#0f172a';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        if (imgMap.complete && imgMap.naturalWidth > 0) {
          ctx.drawImage(imgMap, mapRect.x, mapRect.y, mapRect.w, mapRect.h);
        } else {
          ctx.fillStyle = '#1e293b';
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          ctx.strokeStyle = '#334155';
          ctx.beginPath();
          ctx.moveTo(0, 0);
          ctx.lineTo(canvas.width, canvas.height);
          ctx.moveTo(canvas.width, 0);
          ctx.lineTo(0, canvas.height);
          ctx.stroke();
        }

        if (clickMarker.life > 0) {
          ctx.globalAlpha = clickMarker.life;
          ctx.strokeStyle = '#00ff00';
          ctx.lineWidth = 3;
          ctx.beginPath();
          ctx.arc(clickMarker.x, clickMarker.y, 15, 0, Math.PI * 2);
          ctx.stroke();
          ctx.globalAlpha = 1.0;
        }

        minions.forEach((m) => {
          ctx.fillStyle = 'rgba(0,0,0,0.3)';
          ctx.beginPath();
          ctx.ellipse(m.x, m.y + 40, 30, 10, 0, 0, Math.PI * 2);
          ctx.fill();

          const size = 100;
          let flip = m.x < gamePlayer.x;

          ctx.save();
          ctx.translate(m.x, m.y);
          if (flip) ctx.scale(-1, 1);

          if (imgMinion.complete && imgMinion.naturalWidth > 0) {
            ctx.drawImage(imgMinion, -size / 2, -size / 2, size, size);
          } else {
            ctx.fillStyle = '#ef4444';
            ctx.fillRect(-size / 2, -size / 2, size, size);
          }
          ctx.restore();
        });

        projectiles.forEach((p) => {
          const size = 80;
          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate(Math.atan2(p.vy, p.vx) - Math.PI / 2);

          if (imgQ.complete && imgQ.naturalWidth > 0) {
            ctx.drawImage(imgQ, -size / 2, -size / 2, size, size * 1.5);
          } else {
            ctx.fillStyle = '#facc15';
            ctx.fillRect(-10, -30, 20, 60);
          }
          ctx.restore();
        });

        playerEl.style.left = gamePlayer.x + 'px';
        playerEl.style.top = gamePlayer.y + 'px';
      }

      function spawnWave() {
        gameState.wave++;
        const count = 3 + Math.floor(gameState.wave / 2);
        for (let i = 0; i < count; i++) {
          let side = Math.floor(Math.random() * 4);
          let x, y;
          const buffer = 100;
          if (side === 0) {
            x = Math.random() * canvas.width;
            y = -buffer;
          } else if (side === 1) {
            x = canvas.width + buffer;
            y = Math.random() * canvas.height;
          } else if (side === 2) {
            x = Math.random() * canvas.width;
            y = canvas.height + buffer;
          } else {
            x = -buffer;
            y = Math.random() * canvas.height;
          }
          minions.push({ x, y });
        }
      }

      function castQ() {
        if (gameState.cds.q > 0) return;
        gameState.cds.q = CONF.qCd;

        let dx = mouse.x - gamePlayer.x;
        let dy = mouse.y - gamePlayer.y;
        let len = Math.sqrt(dx * dx + dy * dy);

        let vx = (dx / len) * CONF.qSpeed;
        let vy = (dy / len) * CONF.qSpeed;

        projectiles.push({
          x: gamePlayer.x,
          y: gamePlayer.y,
          vx: vx,
          vy: vy,
        });
      }

      function castDash(dist) {
        let dx = mouse.x - gamePlayer.x;
        let dy = mouse.y - gamePlayer.y;
        let len = Math.sqrt(dx * dx + dy * dy);
        let actualDist = Math.min(len, dist);

        gamePlayer.x += (dx / len) * actualDist;
        gamePlayer.y += (dy / len) * actualDist;
        gamePlayer.x = Math.max(0, Math.min(canvas.width, gamePlayer.x));
        gamePlayer.y = Math.max(0, Math.min(canvas.height, gamePlayer.y));
        gamePlayer.moving = false;
      }

      function damagePlayer() {
        gameState.hp--;
        playerEl.style.filter = 'sepia(1) saturate(5) hue-rotate(-50deg)';
        setTimeout(
          () =>
            (playerEl.style.filter =
              'drop-shadow(0 15px 15px rgba(0,0,0,0.6))'),
          200
        );

        if (gameState.hp <= 0) {
          // GAME OVER LOGIC
          gameActive = false; // Pause updates
          if (gameState.score > sessionHighScore) {
            sessionHighScore = gameState.score;
          }

          // Update Text
          document.getElementById('final-score').innerText = gameState.score;
          document.getElementById('high-score').innerText = sessionHighScore;

          // Show UI
          gameOverScreen.style.display = 'flex';
          exitBtnTopLeft.style.display = 'block';
        }
      }

      window.addEventListener('mousemove', (e) => {
        mouse.x = e.clientX;
        mouse.y = e.clientY;
      });

      window.addEventListener('mousedown', (e) => {
        if (!gameActive) return;

        if (e.button === 2) {
          gamePlayer.tx = e.clientX;
          gamePlayer.ty = e.clientY;
          gamePlayer.moving = true;
          clickMarker.x = e.clientX;
          clickMarker.y = e.clientY;
          clickMarker.life = 1.0;
        }
        if (e.button === 0) {
          castQ();
        }
      });

      window.addEventListener('keydown', (e) => {
        if (!gameActive) return;
        const k = e.key.toLowerCase();

        if (k === 'q') castQ();
        if (k === 'e' && gameState.cds.e <= 0) {
          gameState.cds.e = CONF.eCd;
          castDash(CONF.eDist);
        }
        if (k === 'f' && gameState.cds.f <= 0) {
          gameState.cds.f = CONF.fCd;
          castDash(CONF.fDist);
        }
      });

      function updateHUD() {
        document.getElementById('hud-score').innerText = gameState.score;
        document.getElementById('hud-wave').innerText = gameState.wave;
        document.getElementById('hud-hp').innerText = gameState.hp;
        updateCd('q', CONF.qCd);
        updateCd('e', CONF.eCd);
        updateCd('f', CONF.fCd);
      }

      function updateCd(key, max) {
        const val = gameState.cds[key];
        const el = document.getElementById('cd-' + key);
        const txt = document.getElementById('cdt-' + key);
        const icon = document.getElementById('icon-' + key);

        if (val <= 0) {
          el.style.height = '0%';
          txt.innerText = '';
          icon.classList.add('ready');
        } else {
          const pct = (val / max) * 100;
          el.style.height = pct + '%';
          txt.innerText = val.toFixed(1);
          icon.classList.remove('ready');
        }
      }
    </script>
  </body>
</html>
